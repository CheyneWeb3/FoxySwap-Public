<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BBYDoge – NFT Collections</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://api.foxyswap.net">
  <style>
    .truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
  <header class="sticky top-0 z-10 backdrop-blur bg-slate-900/80 border-b border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col sm:flex-row gap-3 sm:items-end sm:justify-between">
      <div>
        <h1 class="text-2xl font-bold">NFT Collections</h1>
        <p class="text-slate-400 text-sm">Live data from api.foxyswap.net</p>
      </div>
      <form id="controls" class="grid grid-cols-2 sm:grid-cols-6 gap-2 w-full sm:w-auto">
        <input id="q" type="search" placeholder="Search name / symbol / address" class="col-span-2 sm:col-span-3 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500" />
        <select id="standard" class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500">
          <option value="">All</option>
          <option value="ERC721">ERC721</option>
          <option value="ERC1155">ERC1155</option>
        </select>
        <select id="sort" class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500">
          <option value="updated">Updated</option>
          <option value="name">Name</option>
          <option value="block">First Seen Block</option>
        </select>
        <select id="order" class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500">
          <option value="desc">Desc</option>
          <option value="asc">Asc</option>
        </select>
        <label class="flex items-center gap-2 text-sm justify-self-start sm:justify-self-auto">
          <input id="hasImage" type="checkbox" class="accent-emerald-500" />
          <span>Images only</span>
        </label>
      </form>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <div id="stats" class="mb-4 text-sm text-slate-400"></div>
    <div id="grid" class="grid gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"></div>

    <div class="mt-8 flex items-center justify-between gap-3">
      <button id="prev" class="px-4 py-2 rounded-lg bg-slate-800 border border-slate-700 disabled:opacity-50">Prev</button>
      <div id="pageInfo" class="text-sm text-slate-400"></div>
      <button id="next" class="px-4 py-2 rounded-lg bg-slate-800 border border-slate-700 disabled:opacity-50">Next</button>
    </div>
  </main>

  <template id="card-tpl">
    <a class="group block rounded-2xl overflow-hidden border border-slate-800 bg-slate-900 hover:border-emerald-600/60 hover:shadow-lg hover:shadow-emerald-600/10 transition">
      <div class="aspect-square bg-slate-800/60 overflow-hidden">
        <img class="w-full h-full object-cover" loading="lazy" alt="collection image" />
      </div>
      <div class="p-3">
        <div class="flex items-center justify-between gap-2 mb-1">
          <h3 class="font-semibold truncate"></h3>
          <span class="text-xs px-2 py-1 rounded bg-slate-800 border border-slate-700"></span>
        </div>
        <p class="text-emerald-400 text-sm font-mono truncate"></p>
        <p class="text-slate-400 text-xs mt-1 truncate-2"></p>
      </div>
    </a>
  </template>

  <script>
    const API_BASE = 'https://api.foxyswap.net';
    const LIMIT = 24; // items per page

    let state = {
      page: 1,
      q: '',
      standard: '',
      sort: 'updated',
      order: 'desc',
      hasImage: false,
    };

    const els = {
      q: document.getElementById('q'),
      standard: document.getElementById('standard'),
      sort: document.getElementById('sort'),
      order: document.getElementById('order'),
      hasImage: document.getElementById('hasImage'),
      grid: document.getElementById('grid'),
      stats: document.getElementById('stats'),
      tpl: document.getElementById('card-tpl'),
      prev: document.getElementById('prev'),
      next: document.getElementById('next'),
      pageInfo: document.getElementById('pageInfo'),
    };

    function debounce(fn, ms=350){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

    function fixLocalhost(url){
      if (!url) return null;
      try {
        const u = new URL(url, API_BASE);
        if (u.hostname === 'localhost' || u.hostname === '127.0.0.1') {
          u.protocol = 'https:'; u.host = new URL(API_BASE).host;
        }
        return u.toString();
      } catch { return url; }
    }

    async function fetchCollections(){
      const params = new URLSearchParams();
      params.set('limit', LIMIT);
      params.set('page', state.page);
      if (state.q) params.set('q', state.q);
      if (state.standard) params.set('standard', state.standard);
      if (state.hasImage) params.set('hasImage', 'true');
      // sorting is done server-side via our /collections facade
      params.set('sort', state.sort);
      params.set('order', state.order);

      const url = `${API_BASE}/collections?${params.toString()}`;
      const res = await fetch(url, { headers: { 'Accept':'application/json' } });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    function render(items, meta){
      els.grid.innerHTML = '';
      for (const it of items){
        const card = els.tpl.content.firstElementChild.cloneNode(true);
        const img = card.querySelector('img');
        const title = card.querySelector('h3');
        const badge = card.querySelector('span');
        const symbol = card.querySelector('p:nth-of-type(1)');
        const desc = card.querySelector('p:nth-of-type(2)');

        const imageUrl = fixLocalhost(it.imageUrl || it?.token1?.publicImageUrl);
        img.src = imageUrl || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><rect width="100%" height="100%" fill="%231f2937"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%239ca3af" font-family="monospace" font-size="18">no image</text></svg>';
        img.onerror = () => { img.style.opacity = 0.6; };

        title.textContent = it.name || it.address;
        badge.textContent = it.standard || 'NFT';
        symbol.textContent = it.symbol ? `$${it.symbol}` : it.address;
        const m = it?.token1?.metadata;
        desc.textContent = (m?.description || it.externalUrl || '').toString().slice(0, 140);

        // Link to the JSON detail (you can change this to a pretty UI route later)
        card.href = `${API_BASE}/collections/${it.address}`;
        card.target = '_blank';
        card.rel = 'noopener noreferrer';

        els.grid.appendChild(card);
      }

      els.stats.textContent = `Showing ${meta.count} item(s) – Page ${meta.page}`;
      els.pageInfo.textContent = `Page ${meta.page}`;
      els.prev.disabled = state.page <= 1;
      els.next.disabled = meta.count < LIMIT; // naive next check
    }

    async function load(){
      try {
        const data = await fetchCollections();
        // Our /collections facade returns { page, limit, count, items }
        const items = Array.isArray(data.items) ? data.items : data; // if the raw route is used
        const meta = Array.isArray(data.items) ? data : { page: state.page, count: items.length };
        render(items, meta);
      } catch (e) {
        els.grid.innerHTML = `<div class="text-slate-400">Failed to load collections: ${e.message}</div>`;
      }
    }

    // Controls
    els.q.addEventListener('input', debounce(ev => { state.q = ev.target.value.trim(); state.page = 1; load(); }));
    els.standard.addEventListener('change', ev => { state.standard = ev.target.value; state.page = 1; load(); });
    els.sort.addEventListener('change', ev => { state.sort = ev.target.value; load(); });
    els.order.addEventListener('change', ev => { state.order = ev.target.value; load(); });
    els.hasImage.addEventListener('change', ev => { state.hasImage = ev.target.checked; state.page = 1; load(); });
    els.prev.addEventListener('click', () => { if (state.page>1){ state.page--; load(); } });
    els.next.addEventListener('click', () => { state.page++; load(); });

    load();
  </script>
</body>
</html>
